const navLinks=document.querySelectorAll(".header.nav-link");function normalize(e){if(!e)return"/";try{let t=new URL(e,location.origin),n=t.pathname.toLowerCase();return(n=n.replace(/\/index\.html$/,"")).length>1&&n.endsWith("/")&&(n=n.slice(0,-1)),n}catch(r){return e}}let prefix="";function addPrefix(e){return e?(e.startsWith("/")||(e="/"+e),e.startsWith("/admin")||e.startsWith("/user"))?e:prefix+e:""}location.pathname.startsWith("/admin")&&(prefix="/admin"),location.pathname.startsWith("/user")&&(prefix="/user");const current=normalize(location.pathname);let bestLength=-1;function close(e){document.querySelector(e).classList.add("d-none")}function open(e){document.querySelector(e).classList.remove("d-none")}function formatDateToInput(e){let t=new Date(e),n=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${n}-${r}-${o}`}function formatDateToDDMMYYYY(e){let t=new Date(e),n=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${o}-${r}-${n}`}function openForm(e){document.querySelector(e).classList.remove("d-none"),document.querySelector(e).classList.add("d-flex"),document.body.style.overflow="hidden"}function closeForm(e){document.querySelector(e).classList.remove("d-flex"),document.querySelector(e).classList.add("d-none"),document.body.style.overflow="auto"}function showErr(e,t,n){t&&(t.textContent=n,t.classList.remove("d-none"),e.classList.add("is-invalid"))}function hideErr(e,t){t&&(t.textContent="",t.classList.add("d-none"),e.classList.remove("is-invalid"))}function validaRong(e,t,n){let r=document.getElementsByName(e);r.length>0&&r[0].addEventListener("blur",function(){let e=document.querySelector(t);""===this.value.trim()?showErr(this,e,n+" kh\xf4ng thể để trống"):hideErr(this,e)})}function validaChu(e,t,n){let r=document.getElementsByName(e);r.length>0&&r[0].addEventListener("blur",function(){let e=document.querySelector(t);""===this.value.trim()?showErr(this,e,n+" kh\xf4ng thể để trống"):/^[\p{L}\s]+$/u.test(this.value)?hideErr(this,e):showErr(this,e,n+" kh\xf4ng c\xf3 k\xed tự đặc biệt v\xe0 số")})}function validaChuSo(e,t,n){let r=document.getElementsByName(e);r.length>0&&r[0].addEventListener("blur",function(){let e=document.querySelector(t);""===this.value.trim()?showErr(this,e,n+" kh\xf4ng thể để trống"):/^[\p{L}\d\s]+$/u.test(this.value)?hideErr(this,e):showErr(this,e,n+" kh\xf4ng c\xf3 k\xed tự đặc biệt")})}function validaSo(e,t,n,r,o){let i=document.getElementsByName(e);i.length>0&&i[0].addEventListener("blur",function(){let e=document.querySelector(t),i=this.value.trim();""===i?showErr(this,e,o+" kh\xf4ng được để trống"):isNaN(i)?showErr(this,e,o+" phải l\xe0 số"):Number(i)>r?showErr(this,e,o+" kh\xf4ng thể lớn hơn "+r):Number(i)<n?showErr(this,e,o+" kh\xf4ng thể nhỏ hơn "+n):hideErr(this,e)})}function validaSoLimit(e,t,n,r){let o=document.getElementsByName(e);o.length>0&&o[0].addEventListener("blur",function(){let e=document.querySelector(t),o=this.value.trim(),i=RegExp(`^\\d{${n}}$`);""===o?showErr(this,e,r+" kh\xf4ng được để trống"):isNaN(o)?showErr(this,e,r+" phải l\xe0 số"):i.test(o)?hideErr(this,e):showErr(this,e,r+" phải đủ "+n+" số")})}function vaidaAnh(e,t,n){let r=document.getElementsByName(e);r[n]&&r[n].addEventListener("blur",function(){let e=document.querySelector(t),n=this.files&&this.files[0]?this.files[0]:null;if(!n){hideErr(this,e);return}if(!["image/jpeg","image/png","image/jpg","image/gif"].includes(n.type)){showErr(this,e,"File phải l\xe0 ảnh (jpg, png, jpeg, gif)"),this.value="";return}hideErr(this,e)})}function validaPassWord(e,t){let n=document.getElementsByName(e);n.length>0&&n[0].addEventListener("blur",function(){let e=document.querySelector(t);""===this.value.trim()?showErr(this,e,"Mật khẩu kh\xf4ng được để trống"):hideErr(this,e)})}function checkValidAddress(e){if(!e)return!1;var t=e.split(",");if(t.length<3)return!1;for(var n=0;n<t.length;n++)if(""===t[n].trim())return!1;return!0}navLinks.forEach(e=>{let t=e.getAttribute("href");if(!t||"#"===t)return;let n=addPrefix(t),r=normalize(n),o=current===r,i=current.startsWith(r+"/");(o||i)&&r.length>bestLength&&(bestLength=r.length)}),navLinks.forEach(e=>e.classList.remove("header-selected","active")),bestLength>-1&&navLinks.forEach(e=>{let t=e.getAttribute("href");if(!t||"#"===t)return;let n=addPrefix(t),r=normalize(n),o=current===r,i=current.startsWith(r+"/");if((o||i)&&r.length===bestLength){e.classList.add("header-selected","active");let a=e.closest(".dropdown");if(a){let l=a.querySelector('[data-bs-toggle="dropdown"]');l&&!l.classList.contains("active")&&l.classList.add("header-selected","active")}}});const myModal=new bootstrap.Modal(document.getElementById("statusModal")),modalContent=document.getElementById("modalContent"),notifyIcon=document.getElementById("notifyIcon"),notifyTitle=document.getElementById("notifyTitle"),timerBar=document.getElementById("timerBar");let closeTimeout;function showNotification(e,t){clearTimeout(closeTimeout),timerBar.classList.remove("running"),timerBar.offsetWidth,"success"===e?(modalContent.className="modal-content success-theme",notifyIcon.className="status-icon bi bi-check-circle-fill d-block mb-3"):(modalContent.className="modal-content failure-theme",notifyIcon.className="status-icon bi bi-x-circle-fill d-block mb-3"),notifyTitle.textContent=t,myModal.show(),timerBar.classList.add("running"),closeTimeout=setTimeout(()=>{myModal.hide()},1e3)}async function ThemPhongTro(){try{document.getElementsByName("TenPhong")[0].value="",document.getElementsByName("DienTich")[0].value="",document.getElementsByName("Gia")[0].value="",document.getElementsByName("HinhCu")[0].value="",document.querySelector(".TenPhongTest").innerText="T\xean Ph\xf2ng",document.querySelector(".DienTichTest").innerText=0,document.querySelector(".GiaTest").innerText=0,document.querySelector(".AnhPhongTest").src="/img/logo.png",openForm(".form-phong-cover"),document.querySelector(".form-phong-title").innerText="Th\xeam Ph\xf2ng"}catch(e){console.error("Lỗi:",e)}}async function SuaPhongTro(e){try{let t=await fetch(`/admin/phongtro/${e}`);if(!t.ok){alert("Kh\xf4ng lấy được dữ liệu!");return}let n=await t.json();console.log("Dữ liệu nhận được:",n);let r=n.Ten,o=n.DienTich,i=n.Gia,a=i.replace(/\./g,""),l=n.HinhAnh;document.getElementsByName("TenPhong")[0].value=r,document.getElementsByName("DienTich")[0].value=o,document.getElementsByName("Gia")[0].value=a,document.getElementsByName("HinhCu")[0].value=l,document.querySelector(".TenPhongTest").innerText=r,document.querySelector(".DienTichTest").innerText=Number(o),document.querySelector(".GiaTest").innerText=Number(a).toLocaleString("vi-VN"),document.querySelector(".AnhPhongTest").src="/img/"+l,document.querySelector(".form-phong").action=`/admin/phongtro/${e}?_method=PUT`,openForm(".form-phong-cover"),document.querySelector(".form-phong-title").innerText="Cập Nhật Ph\xf2ng"}catch(u){console.error("Lỗi:",u)}}async function XoaPhongTro(e,t){try{document.getElementsByName("HinhXoa")[0].value=t,openForm(".form-phong-xoa-cover"),document.querySelector(".form-phong-xoa").action=`/admin/phongtro/${e}?_method=DELETE`}catch(n){console.error("Lỗi:",n)}}validaChuSo("TenPhong","#tenPhongError","T\xean ph\xf2ng"),validaSo("DienTich","#dienTichError",1,1e3,"Diện t\xedch"),validaSo("Gia","#giaPhongError",1e5,1e8,"Gi\xe1 ph\xf2ng"),vaidaAnh("Hinh","#anhPhongError",0);const formPhong=document.querySelector(".form-phong");function xemThuAnh(e,t){if(e.files&&e.files[0]){let n=new FileReader;n.onload=function(e){let n=document.querySelector(t);n.src=e.target.result},n.readAsDataURL(e.files[0])}}async function ThemNguoiDung(){try{let e=new Date;document.getElementsByName("MaND")[0].value="",document.getElementsByName("HoTenND")[0].value="",document.getElementsByName("CMNDND")[0].value="",document.getElementsByName("NamSinhND").value=formatDateToInput(e),document.getElementsByName("SDTND")[0].value="",document.getElementsByName("ThuongTruND")[0].value="",document.getElementById("street").value="",document.getElementsByName("QuyenND")[0].value="",document.getElementsByName("HinhNDCu")[0].value="",openForm(".form-nguoidung-cover"),document.querySelector(".form-nguoidung-title").innerText="Th\xeam Người D\xf9ng",close(".btnDatLaiMK"),close(".btnXoaND")}catch(t){console.error("Lỗi:",t)}}async function SuaNguoiDung(e){try{let t=await fetch(`/admin/nguoidung/${e}`);if(!t.ok){alert("Kh\xf4ng lấy được dữ liệu!");return}let n=await t.json();console.log("Dữ liệu nhận được:",n),document.getElementsByName("MaND")[0].value=n.MaND,document.getElementsByName("HoTenND")[0].value=n.HoTen,document.getElementsByName("CMNDND")[0].value=n.CCCD,document.getElementsByName("NamSinhND")[0].value=formatDateToInput(n.NamSinh),document.getElementsByName("SDTND")[0].value=n.SDT,document.getElementsByName("ThuongTruND")[0].value=n.ThuongTru,document.getElementById("street").value=n.ThuongTru.split(",")[0].trim(),document.getElementsByName("QuyenND")[0].value=n.Quyen,document.getElementsByName("HinhNDCu")[0].value=n.AVT,n.AVT&&(document.querySelector(".AVTND").src="/img/"+n.AVT),openForm(".form-nguoidung-cover"),document.querySelector(".form-nguoidung-title").innerText="Th\xf4ng Tin Người D\xf9ng",document.querySelector(".form-nguoidung").action=`/admin/nguoidung/${n.MaND}?_method=PUT`,open(".btnDatLaiMK"),open(".btnXoaND");let r=document.querySelector(".btnXoaND"),o=document.querySelector(".btnDatLaiMK");o.dataset.id=n.MaND,r.dataset.id=n.MaND,r.dataset.hinh=n.AVT}catch(i){console.error("Lỗi:",i)}}function XoaNguoiDung(e){openForm(".form-nguoidung-xn-cover"),document.querySelector(".form-nguoidung-xn-title").innerText="Bạn c\xf3 muốn x\xf3a người d\xf9ng n\xe0y kh\xf4ng";let t=e.dataset.id,n=e.dataset.hinh;document.getElementsByName("HinhNDxn")[0].value=n,document.querySelector(".form-nguoidung-xn").action=`/admin/nguoidung/${t}?_method=DELETE`}function DLMKNguoiDung(e){openForm(".form-nguoidung-xn-cover"),document.querySelector(".form-nguoidung-xn-title").innerText="Bạn c\xf3 muốn đặt lại mật khẩu người d\xf9ng n\xe0y kh\xf4ng";let t=e.dataset.id;document.getElementsByName("HinhNDxn")[0].value="",document.querySelector(".form-nguoidung-xn").action=`/admin/nguoidung/datlaimk/${t}?_method=POST`}formPhong&&formPhong.addEventListener("submit",function(e){let t=!1,n=document.getElementsByName("TenPhong")[0],r=document.getElementsByName("Gia")[0],o=document.getElementsByName("DienTich")[0],i=document.getElementsByName("Hinh")[0],a=n.value.trim(),l=r.value.trim(),u=o.value.trim();""!==a&&/^[\p{L}\d\s]+$/u.test(a)||(showErr(n,document.querySelector("#tenPhongError"),"T\xean ph\xf2ng kh\xf4ng hợp lệ"),t=!0),(""===l||1e5>Number(l)||Number(l)>1e8)&&(showErr(r,document.querySelector("#giaPhongError"),"Gi\xe1 kh\xf4ng hợp lệ"),t=!0),(""===u||1>Number(u)||Number(u)>500)&&(showErr(o,document.querySelector("#dienTichError"),"Diện t\xedch kh\xf4ng hợp lệ"),t=!0);let s=i.files[0];s&&!["image/jpeg","image/png","image/jpg","image/gif"].includes(s.type)&&(showErr(i,document.querySelector("#anhPhongError"),"File phải l\xe0 ảnh (jpg, png, jpeg, gif)"),t=!0,i.value=""),t&&e.preventDefault()}),validaChu("HoTenND","#HoTenNDError","Họ v\xe0 t\xean"),validaSoLimit("CMNDND","#CMNDNDError",12,"CMND"),validaSoLimit("SDTND","#SDTNDError",10,"Số điện thoại"),validaRong("ThuongTruND","ThuongTruNDError","Địa chỉ thường tr\xfa"),vaidaAnh("HinhND","#HinhNDError",0);const formNguoiDung=document.querySelector(".form-nguoidung");async function CapNhatThongTin(e,t){try{let n=await fetch(`/${t}/acc/${e}`);if(!n.ok){alert("Kh\xf4ng lấy được dữ liệu!");return}let r=await n.json();document.getElementsByName("HoTenTT")[0].value=r.HoTen,document.getElementsByName("CMNDTT")[0].value=r.CCCD,document.getElementsByName("NamSinhTT")[0].value=formatDateToInput(r.NamSinh),document.getElementsByName("SDTTT")[0].value=r.SDT,document.getElementsByName("ThuongTruTT")[0].value=r.ThuongTru,document.getElementById("street").value=r.ThuongTru.split(",")[0].trim(),document.getElementsByName("HinhTTCu")[0].value=r.AVT,r.AVT&&(document.querySelector(".AVTTT").src="/img/"+r.AVT),openForm(".form-thongtin-cover"),document.querySelector(".form-thongtin-title").innerText="Th\xf4ng Tin Người D\xf9ng",document.querySelector(".form-thongtin").action=`/${t}/accupdate/${e}?_method=PUT`}catch(o){console.error("Lỗi:",o)}}formNguoiDung&&formNguoiDung.addEventListener("submit",function(e){let t=!1,n=document.getElementsByName("HoTenND")[0],r=document.getElementsByName("CMNDND")[0],o=document.getElementsByName("SDTND")[0],i=document.getElementsByName("ThuongTruND")[0],a=document.getElementsByName("HinhND")[0],l=document.getElementsByName("NamSinhND")[0],u=n.value.trim(),s=r.value.trim(),c=o.value.trim(),h=i.value.trim(),m=/^[\p{L}\s]+$/u;""!==u&&m.test(u)||(showErr(n,document.querySelector("#HoTenNDError"),"Họ t\xean kh\xf4ng hợp lệ"),t=!0),""!==s&&/^\d{12}$/.test(s)||(showErr(r,document.querySelector("#CMNDNDError"),"CMND kh\xf4ng hợp lệ"),t=!0),""!==c&&/^\d{12}$/.test(sđt)||(showErr(o,document.querySelector("#SDTNDError"),"SĐT kh\xf4ng hợp lệ"),t=!0),""!==h&&m.test(h)&&checkValidAddress(h)||(showErr(i,document.querySelector("#ThuongTruNDError"),"Địa chỉ kh\xf4ng hợp lệ"),t=!0);let d=a.files[0];d&&!["image/jpeg","image/png","image/jpg","image/gif"].includes(d.type)&&(showErr(a,document.querySelector("#HinhNDError"),"File phải l\xe0 ảnh (jpg, png, jpeg, gif)"),t=!0,a.value="");let g=new Date;g.setFullYear(today.getFullYear()-18);{l.setAttribute("max",formatDateToInput(g));let y=l.value;if(y){let T=new Date(y);T>g&&(showErr(l,document.querySelector("#NamSinhNDError"),"Năm sinh phải đủ 18 tuổi trở l\xean."),t=!0)}}t&&e.preventDefault()}),validaChu("HoTenTT","#HoTenTTError","Họ v\xe0 t\xean"),validaSoLimit("CMNDTT","#CMNDTTError",12,"CMND"),validaSoLimit("SDTTT","#SDTTTError",10,"Số điện thoại"),validaRong("ThuongTruTT","ThuongTruTTError","Địa chỉ thường tr\xfa"),vaidaAnh("HinhTT","#HinhTTError",0);const formThongTin=document.querySelector(".form-thongtin");function setupPasswordToggle(e,t,n){let r=document.getElementById(e),o=document.getElementById(t),i=document.getElementById(n);o&&o.addEventListener("click",function(){let e="password"===r.getAttribute("type")?"text":"password";r.setAttribute("type",e),"text"===e?(i.classList.remove("bi-eye"),i.classList.add("bi-eye-slash")):(i.classList.remove("bi-eye-slash"),i.classList.add("bi-eye"))})}formThongTin&&formThongTin.addEventListener("submit",function(e){let t=!1,n=document.getElementsByName("HoTenTT")[0],r=document.getElementsByName("CMNDTT")[0],o=document.getElementsByName("SDTTT")[0],i=document.getElementsByName("ThuongTruTT")[0],a=document.getElementsByName("HinhTT")[0],l=n.value.trim(),u=r.value.trim(),s=o.value.trim(),c=i.value.trim(),h=/^[\p{L}\s]+$/u;""!==l&&h.test(l)||(showErr(n,document.querySelector("#HoTenTTError"),"Họ t\xean kh\xf4ng hợp lệ"),t=!0),""!==u&&/^\d{12}$/.test(u)||(showErr(r,document.querySelector("#CMNDTTError"),"CMND kh\xf4ng hợp lệ"),t=!0),""!==s&&/^\d{12}$/.test(sđt)||(showErr(o,document.querySelector("#SDTTTError"),"SĐT kh\xf4ng hợp lệ"),t=!0),""!==c&&h.test(c)&&checkValidAddress(c)||(showErr(i,document.querySelector("#ThuongTruTTError"),"Địa chỉ kh\xf4ng hợp lệ"),t=!0);let m=a.files[0];m&&!["image/jpeg","image/png","image/jpg","image/gif"].includes(m.type)&&(showErr(a,document.querySelector("#HinhTTError"),"File phải l\xe0 ảnh (jpg, png, jpeg, gif)"),t=!0,a.value="");let d=document.getElementsByName("NamSinhTT")[0],g=new Date;g.setFullYear(today.getFullYear()-18);{d.setAttribute("max",formatDateToInput(g));let y=d.value;if(y){let T=new Date(y);T>g&&(showErr(d,document.querySelector("#NamSinhTTError"),"Năm sinh phải đủ 18 tuổi trở l\xean."),t=!0)}}t&&e.preventDefault()}),setupPasswordToggle("MKCInput","toggleMKC","iconMKC"),setupPasswordToggle("MKMInput","toggleMKM","iconMKM"),setupPasswordToggle("XNMKMInput","toggleXNMKM","iconXNMKM"),validaPassWord("MKC","#MKCError"),validaPassWord("MKM","#MKMError"),validaPassWord("XNMKM","#XNMKMError");const formDMK=document.querySelector(".form-doimk");async function ThemHopDong(){try{let e=new Date,t=await fetch("/admin/hopdong/laydulieutao");if(!t.ok){alert("Kh\xf4ng lấy được dữ liệu!");return}let n=await t.json(),r=document.querySelector(".PhongHDT");r.innerHTML='<option value="">-- Chọn ph\xf2ng trọ --</option>',n.dsPhong.forEach(e=>{let t=document.createElement("option");t.value=e.MaPhong,t.textContent=`${e.Ten}`,r.appendChild(t)});let o=document.querySelector(".containerNguoiThue");o.innerHTML="",n.dsNguoi.forEach(e=>{let t=`
                <div class="mb-2">
                        
                        <input class="form-check-input me-2" 
                            type="checkbox" 
                            name="NThue[]" 
                            value="${e.MaND}" 
                            id="user-${e.MaND}"
                            style="transform: scale(1.2);"> <label class="form-check-label" for="user-${e.MaND}" style="cursor: pointer;">
                            <span class="fw-bold">${e.HoTen}</span> <br>
                        </label>
                </div>
            `;o.insertAdjacentHTML("beforeend",t)}),document.getElementsByName("NgayBD")[0].setAttribute("min",formatDateToInput(e)),document.getElementsByName("NgayBD")[0].value=formatDateToInput(e),document.getElementsByName("NgayKT")[0].value=formatDateToInput(e),document.getElementsByName("TienCoc")[0].value="",openForm(".form-hdt-cover"),document.querySelector(".form-hdt-title").innerText="Tạo Hợp Đồng Thu\xea"}catch(i){console.error("Lỗi:",i)}}async function SuaHopDong(e){try{let t=await fetch(`/admin/hopdong/laydulieusua/${e}`);if(!t.ok){alert("Kh\xf4ng lấy được dữ liệu!");return}let n=await t.json(),r=document.querySelector(".PhongHDT");r.innerHTML='<option value="">-- Chọn ph\xf2ng trọ --</option>',n.dsPhong.forEach(e=>{let t=document.createElement("option");t.value=e.MaPhong,t.textContent=`${e.Ten}`,e.isSelected&&(t.selected=!0),r.appendChild(t)});let o=document.querySelector(".containerNguoiThue");o.innerHTML="",n.dsNguoi.forEach(e=>{let t=e.isChecked?"checked":"",n=`
                <div class="mb-2">
                        <input class="form-check-input me-2" 
                            type="checkbox" 
                            name="NThue[]" 
                            value="${e.MaND}" 
                            id="user-${e.MaND}"
                            style="transform: scale(1.2);"
                            ${t}> 
                            <label class="form-check-label" for="user-${e.MaND}" style="cursor: pointer;">
                            <span class="fw-bold">${e.HoTen}</span> <br>
                        </label>
                </div>
            `;o.insertAdjacentHTML("beforeend",n)}),document.getElementsByName("NgayBD")[0].value=formatDateToInput(n.HDT.NgayBD),document.getElementsByName("NgayKT")[0].value=formatDateToInput(n.HDT.NgayKT),document.getElementsByName("TienCoc")[0].value=n.HDT.TienCoc,document.querySelector(".form-hdt").action=`/admin/hopdong/${e}?_method=PUT`,openForm(".form-hdt-cover"),document.querySelector(".form-hdt-title").innerText="Sửa Hợp Đồng Thu\xea"}catch(i){console.error("Lỗi:",i)}}function XoaHopDong(e){openForm(".form-hopdong-xn-cover"),document.querySelector(".form-hopdong-xn-title").innerText="Bạn c\xf3 muốn x\xf3a hợp đồng n\xe0y kh\xf4ng",document.querySelector(".form-hopdong-xn").action=`/admin/hopdong/${e}?_method=DELETE`}function KTHopDong(e){openForm(".form-hopdong-xn-cover"),document.querySelector(".form-hopdong-xn-title").innerText="Bạn c\xf3 muốn kết th\xfac hợp đồng n\xe0y kh\xf4ng",document.querySelector(".form-hopdong-xn").action=`/admin/hopdong/kthopdong/${e}?_method=PUT`}formDMK&&formDMK.addEventListener("submit",function(e){let t=!1,n=document.getElementsByName("MKC")[0],r=document.getElementsByName("MKM")[0],o=document.getElementsByName("XNMKM")[0],i=n.value.trim(),a=r.value.trim(),l=o.value.trim();""===i&&(showErr(passInput,document.querySelector("#MKCError"),"Mật khẩu kh\xf4ng được để trống"),t=!0),""===a&&(showErr(passInput,document.querySelector("#MKMError"),"Mật khẩu kh\xf4ng được để trống"),t=!0),""===l&&(showErr(passInput,document.querySelector("#XNMKMError"),"Mật khẩu kh\xf4ng được để trống"),t=!0),l!==a&&(showErr(passInput,document.querySelector("#XNMKMError"),"Mật khẩu mới v\xe0 x\xe1c nhận mật kh\xf4ng phải giống nhau"),showErr(passInput,document.querySelector("#MKMError"),"Mật khẩu mới v\xe0 x\xe1c nhận mật kh\xf4ng phải giống nhau"),t=!0),t&&e.preventDefault()}),validaSo("TienCoc","#TienCocError",0,1e7,"Tiền cọc");const ngayBDInput=document.getElementsByName("NgayBD")[0];ngayBDInput&&ngayBDInput.addEventListener("change",function(){let e=this.value,t=document.getElementsByName("NgayKT")[0];t.setAttribute("min",e),t.value&&t.value<e?(t.value="",showErr(t,document.querySelector("#NgayKTError"),"Vui l\xf2ng chọn lại ng\xe0y kết th\xfac")):hideErr(t,document.querySelector("#NgayKTError"))});const formHDT=document.querySelector(".form-hdt");async function ThemPhuPhi(){try{let e=await fetch("/admin/phuphi/laydulieu");if(!e.ok){alert("Kh\xf4ng lấy được dữ liệu!");return}let t=await e.json(),n=document.querySelector(".containerPhuPhi");n.innerHTML="",t.dsPhong.forEach(e=>{let t=`
                <div class="mb-2">
                        
                        <input class="form-check-input me-2" 
                            type="checkbox" 
                            name="PhongPP[]" 
                            value="${e.MaPhong}" 
                            id="phong-${e.MaPhong}"
                            style="transform: scale(1.2);"> <label class="form-check-label" for="user-${e.MaPhong}" style="cursor: pointer;">
                            <span class="fw-bold">${e.Ten}</span> <br>
                        </label>
                </div>
            `;n.insertAdjacentHTML("beforeend",t)}),document.getElementsByName("TenPP")[0].value="",document.getElementsByName("GiaPP")[0].value="",document.getElementsByName("GhiChuPP")[0].value="",openForm(".form-phuphi-cover"),document.querySelector(".form-phuphi-title").innerText="Tạo Phụ Ph\xed",close(".btnXoaPP")}catch(r){console.error("Lỗi:",r)}}async function SuaPhuPhi(e){try{let t=await fetch(`/admin/phuphi/laydulieusua/${e}`);if(!t.ok){alert("Kh\xf4ng lấy được dữ liệu!");return}let n=await t.json(),r=document.querySelector(".containerPhuPhi");r.innerHTML="",n.dsPhong.forEach(e=>{let t=e.isSelected?"checked":"",n=`
                <div class="mb-2">
                        
                        <input class="form-check-input me-2" 
                            type="checkbox" 
                            name="PhongPP[]" 
                            value="${e.MaPhong}" 
                            id="phong-${e.MaPhong}"
                            style="transform: scale(1.2);"
                            ${t}> 
                            <label class="form-check-label" for="user-${e.MaPhong}" style="cursor: pointer;">
                            <span class="fw-bold">${e.Ten}</span> <br>
                        </label>
                </div>
            `;r.insertAdjacentHTML("beforeend",n)}),document.getElementsByName("TenPP")[0].value=n.PP.TenPP,document.getElementsByName("GiaPP")[0].value=n.PP.Gia,document.getElementsByName("GhiChuPP")[0].value=n.PP.GhiChu,openForm(".form-phuphi-cover"),document.querySelector(".form-phuphi-title").innerText="Sửa Phụ Ph\xed",document.querySelector(".form-phuphi").action=`/admin/phuphi/${e}?_method=PUT`,open(".btnXoaPP"),document.querySelector(".btnXoaPP").dataset.id=e}catch(o){console.error("Lỗi:",o)}}function XoaPhuPhi(e){let t=e.dataset.id;openForm(".form-phuphi-xn-cover"),document.querySelector(".form-phuphi-xn-title").innerText="Bạn c\xf3 muốn x\xf3a phụ ph\xed n\xe0y kh\xf4ng",document.querySelector(".form-phuphi-xn").action=`/admin/phuphi/${t}?_method=DELETE`}formHDT&&formHDT.addEventListener("submit",function(e){e.preventDefault();let t=!1,n=document.getElementsByName("PhongHDT")[0],r=document.getElementsByName("NgayBD")[0],o=document.getElementsByName("NgayKT")[0],i=document.getElementsByName("TienCoc")[0],a=document.querySelectorAll('input[name="NThue[]"]:checked'),l=i.value.trim();(""===l||0>Number(l)||Number(l)>1e8)&&(showErr(i,document.querySelector("#TienCocError"),"Tiền cọc kh\xf4ng hợp lệ"),t=!0),""===n.value&&(showErr(n,document.querySelector("#PhongHDTError"),"Vui l\xf2ng chọn ph\xf2ng"),t=!0);let u=new Date;if(r.setAttribute("min",formatDateToInput(u)),r.value<formatDateToInput(u)&&(showErr(r,document.querySelector("#NgayBDError"),"Ng\xe0y bắt đầu kh\xf4ng hợp lệ"),t=!0),o.value<=r.value&&(showErr(o,document.querySelector("#NgayKTError"),"Ng\xe0y kết th\xfac phải lớn hơn ng\xe0y bắt đầu"),t=!0),0===a.length){let s=document.querySelector("#NThueError"),c=document.querySelector(".containerNguoiThue");showErr(c,s,"Vui l\xf2ng chọn \xedt nhất 1 người thu\xea"),t=!0}t||(console.log("Dữ liệu chuẩn, đang gửi..."),e.currentTarget.submit())}),validaChu("TenPP","#TenPPError","T\xean phụ ph\xed"),validaChu("GhiChuPP","#GhiChuPPError","Ghi ch\xfa"),validaSo("GiaPP","#GiaPPError",0,1e6,"Gi\xe1");const formPhuPhi=document.querySelector(".form-hdt");function moFormGhiDienNuoc(){let e=document.getElementById("modalDienNuoc");e.classList.remove("d-none"),e.classList.add("d-flex");let t=document.getElementById("formWizard");t&&TaoFormChiSo()}function dongFormGhiDienNuoc(){let e=document.getElementById("modalDienNuoc");e.classList.remove("d-flex"),e.classList.add("d-none")}formPhuPhi&&fomPhuPhi.addEventListener("submit",function(e){e.preventDefault();let t=!1,n=document.getElementsByName("TenPP")[0],r=document.getElementsByName("GiaPP")[0],o=document.getElementsByName("GhiChuPP")[0],i=n.value.trim(),a=r.value.trim(),l=o.value.trim(),u=/^[\p{L}\s]+$/u;""!==i&&u.test(i)||(showErr(n,document.querySelector("#TenPPError"),"T\xean phụ ph\xed kh\xf4ng hợp lệ"),t=!0),(""===a||0>Number(a)||Number(a)>1e7)&&(showErr(r,document.querySelector("#GiaPPError"),"Gi\xe1 phụ ph\xed kh\xf4ng hợp lệ"),t=!0),""!==l&&u.test(l)||(showErr(o,document.querySelector("#GhiChuPPError"),"Ghi ch\xfa kh\xf4ng hợp lệ"),t=!0),t||(console.log("Dữ liệu chuẩn, đang gửi..."),e.currentTarget.submit())});const modalDN=document.getElementById("modalDienNuoc");function TaoFormChiSo(){let e=document.querySelectorAll(".step-slide"),t=document.getElementById("btnPrev"),n=document.getElementById("btnNext"),r=document.getElementById("btnSubmit"),o=document.getElementById("stepIndicator"),i=document.getElementById("dataJsonHidden"),a=document.getElementById("formWizard"),l=0,u=e.length;function s(){e.forEach((e,t)=>{t===l?e.classList.remove("d-none"):e.classList.add("d-none")}),t.disabled=0===l,l===u-1?(n.classList.add("d-none"),r.classList.remove("d-none")):(n.classList.remove("d-none"),r.classList.add("d-none")),o&&(o.textContent=`Ph\xf2ng ${l+1} / ${u}`)}n.addEventListener("click",async()=>{let t=e[l],n=t.querySelector(".inp-dien"),r=t.querySelector(".inp-nuoc"),o=t.querySelector(".CSDienError"),i=t.querySelector(".CSNuocError"),a=n.value,c=r.value,h=t.querySelector(".inp-maphong").value,m=await fetch(`/admin/diennuoc/kiemtra/${h}`);if(!m.ok){alert("Kh\xf4ng lấy được dữ liệu!");return}let d=await m.json(),g=Number(d.cs[0].SoDCu.replace(/\./g,"")),y=Number(d.cs[0].SoNCu.replace(/\./g,""));if(a)hideErr(n,o);else{showErr(n,o,"Vui l\xf2ng nhập chỉ số điện");return}if(Number(a)<=g){showErr(n,o,`Chỉ số điện mới phải lớn hơn ${d.cs[0].SoDCu}`);return}if(hideErr(n,o),c)hideErr(r,i);else{showErr(r,i,"Vui l\xf2ng nhập chỉ số nước");return}if(Number(c)<=y){showErr(r,i,`Chỉ số nước phải lớn hơn ${d.cs[0].SoNCu}`);return}hideErr(r,i),l<u-1&&(l++,s())}),t.addEventListener("click",()=>{l>0&&(l--,s())}),a&&a.addEventListener("submit",t=>{t.preventDefault();let n=[];e.forEach(e=>{let t=e.querySelector(".inp-maphong").value,r=e.querySelector(".inp-dien").value,o=e.querySelector(".inp-nuoc").value;t&&n.push({MaPhong:t,SoDMoi:r,SoNMoi:o})});let r=JSON.stringify(n);i.value=r,a.submit()}),s()}async function SuaCSDN(e){try{let t=await fetch(`/admin/diennuoc/laydulieusua/${e}`);if(!t.ok){alert("Kh\xf4ng lấy được dữ liệu!");return}let n=await t.json();document.getElementsByName("CSDC")[0].value=n.cs[0].SoDCu,document.getElementsByName("CSNC")[0].value=n.cs[0].SoDCu,document.getElementsByName("CSDM")[0].value=n.cs[0].SoDMoi,document.getElementsByName("CSNM")[0].value=n.cs[0].SoDMoi,openForm(".form-csdn-cover"),document.querySelector(".form-csdn-title").innerText="Sửa Chỉ số",document.querySelector(".form-csdn").action=`/admin/diennuoc/${e}?_method=PUT`}catch(r){console.error("Lỗi:",r)}}function XoaCSDN(e){openForm(".form-csdn-xn-cover"),document.querySelector(".form-csdn-xn-title").innerText="Bạn c\xf3 muốn x\xf3a chỉ số n\xe0y kh\xf4ng",document.querySelector(".form-csdn-xn").action=`/admin/diennuoc/${e}?_method=DELETE`}function XoaCSDNByNgay(e){openForm(".form-csdn-xn-cover"),document.querySelector(".form-csdn-xn-title").innerText="Bạn c\xf3 muốn x\xf3a chỉ số n\xe0y kh\xf4ng",document.querySelector(".form-csdn-xn").action=`/admin/diennuoc/xoatheongay/${e}?_method=DELETE`}function ChuyenSo(e){let t=parseInt(e.toString().replace(/\./g,""));return Number(t)}function ChuyenSoStr(e){return Number(e).toLocaleString("vi-VN")}modalDN&&modalDN.addEventListener("click",function(e){e.target===this&&dongFormGhiDienNuoc()});const modalDetail=document.getElementById("invoiceModalDetail");async function openInvoiceModal(e,t){modalDetail.style.display="flex",setTimeout(()=>{modalDetail.classList.add("show")},10),document.body.style.overflow="hidden";let n=document.querySelector(".hdTenPhong"),r=document.querySelector(".hdNgayTao"),o=document.querySelector(".csncu"),i=document.querySelector(".csnmoi"),a=document.querySelector(".tieuthunuoc"),l=document.querySelector(".gianuoc"),u=document.querySelector(".tongtiennuoc"),s=document.querySelector(".csdcu"),c=document.querySelector(".csdmoi"),h=document.querySelector(".tieuthudien"),m=document.querySelector(".giadien"),d=document.querySelector(".tongtiendien"),g=document.querySelector(".tongdn"),y=document.querySelector(".tienphong"),T=document.querySelector(".tienpp"),p=document.querySelector(".tiendn"),f=document.querySelector(".thanhtien"),E=await fetch(`/${t}/hoadon/laychitiet/${e}`);if(!E.ok){alert("Kh\xf4ng lấy được dữ liệu!");return}let S=await E.json();n.innerText=S.Phong.Ten,r.innerText=formatDateToDDMMYYYY(S.HD.NgayTinh),s.innerText=S.CS.SoDCu,c.innerText=S.CS.SoDMoi;let N=ChuyenSo(S.CS.SoDMoi)-ChuyenSo(S.CS.SoDCu);h.innerHTML=ChuyenSoStr(N)+" kWh",m.innerText=S.Gia.GiaDien+" VNĐ",d.innerText=S.HD.TienDien+" VNĐ",o.innerText=S.CS.SoNCu,i.innerText=S.CS.SoNMoi;let v=ChuyenSo(S.CS.SoNMoi)-ChuyenSo(S.CS.SoNCu);a.innerHTML=ChuyenSoStr(v)+" m\xb3",l.innerText=S.Gia.GiaNuoc+" VNĐ",u.innerText=S.HD.TienNuoc+" VNĐ";let $=ChuyenSo(S.HD.TienDien)+ChuyenSo(S.HD.TienNuoc);g.innerText=ChuyenSoStr($)+" VNĐ";let D=JSON.parse(S.PP),B=document.getElementById("list-phu-phi"),q="",P=0;B.innerHTML="",D.forEach(e=>{P+=ChuyenSo(e.Gia),q+=`
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>${e.TenPP}</span>
                <span>${e.Gia}</span>
            </li>
        `}),q+=`
        <li class="list-group-item list-group-item-secondary d-flex justify-content-between align-items-center fw-bold">
            <span>Tổng phụ ph\xed</span>
            <span>${ChuyenSoStr(P)}</span>
        </li>
    `,B.innerHTML=q;let L=document.querySelector(".hdTrangThai"),b=S.HD.TrangThai?S.HD.TrangThai.trim().normalize("NFC"):"";"Chờ thanh to\xe1n"==b?L.innerHTML=`<span class="badge bg-warning text-dark fs-6">Chờ thanh to\xe1n</span>`:"Chưa thanh to\xe1n"==b?L.innerHTML=`<span class="badge bg-danger text-dark fs-6">Chưa thanh to\xe1n</span>`:"Đ\xe3 thanh to\xe1n"==b&&(L.innerHTML=`<span class="badge bg-success text-dark fs-6">Đ\xe3 thanh to\xe1n</span>`),y.innerText=S.Phong.Gia+" VNĐ",p.innerText=ChuyenSoStr($)+" VNĐ",T.innerText=ChuyenSoStr(P);let M=$+ChuyenSo(S.Phong.Gia)+P;f.innerText=ChuyenSoStr(M)+" VNĐ"}function closeInvoiceModal(){modalDetail.classList.remove("show"),setTimeout(()=>{modalDetail.style.display="none"},300),document.body.style.overflow="auto"}function XoaHoaDon(e){openForm(".form-hoadon-xn-cover"),document.querySelector(".form-hoadon-xn-title").innerText="Bạn c\xf3 muốn x\xf3a h\xf3a đơn n\xe0y kh\xf4ng",document.querySelector(".form-hoadon-xn").action=`/admin/hoadon/${e}?_method=DELETE`}function XNTraHD(e){openForm(".form-hoadon-xn-cover"),document.querySelector(".form-hoadon-xn-title").innerText="Bạn c\xf3 x\xe1c nhận trả h\xf3a đơn n\xe0y kh\xf4ng",document.querySelector(".form-hoadon-xn").action=`/admin/hoadon/xntra/${e}?_method=POST`}function xoaDauVaKhoangTrang(e){return e?e=(e=(e=e.normalize("NFD").replace(/[\u0300-\u036f]/g,"")).replace(/đ/g,"d").replace(/Đ/g,"D")).replace(/\s+/g,""):""}async function MaQRHD(e){let t=await fetch(`/user/hoadon/taocode/${e}`);if(!t.ok){alert("Kh\xf4ng lấy được dữ liệu!");return}let n=await t.json(),r=document.querySelector(".noidungck");r.innerText=e+"-"+xoaDauVaKhoangTrang(n.TenPhong)+"-"+n.NgayTinh,openForm(".form-hoadon-ma-cover")}function copyText(e){let t=e.innerText.trim();navigator.clipboard.writeText(t),alert("Đ\xe3 sao ch\xe9p !!")}async function sendRequest(e,t,n){try{showLoading();let r=await fetch(e,{method:t,headers:{"Content-Type":"application/json"},body:JSON.stringify({ids:n})});r.ok?window.location.reload():alert("C\xf3 lỗi xảy ra!")}catch(o){console.error(o)}finally{hideLoading()}}async function XoaNhieuTB(e,t){let n=Array.from(document.querySelectorAll(".check-item:checked")).map(e=>e.value);await sendRequest(`/${e}/thongbao/xoanhieu/${t}`,"DELETE",n)}async function DaDocNhieuTB(e,t){let n=Array.from(document.querySelectorAll(".check-item:checked")).map(e=>e.value);await sendRequest(`/${e}/thongbao/dadocnhieu/${t}`,"PUT",n)}async function SoanThongBao(e,t){let n=await fetch(`/${e}/thongbao/laydlsoan`);if(!n.ok){alert("Kh\xf4ng lấy được dữ liệu!");return}let r=await n.json(),o=document.querySelector(".containerNguoiNhan");o.innerHTML="",r.dsNN.forEach(e=>{let t=`
            <div class="mb-2">
                    <input class="form-check-input me-2" 
                        type="checkbox" 
                        name="NNhan[]" 
                        value="${e.MaND}" 
                        id="${e.MaND}"
                        style="transform: scale(1.2);"> 
                        <label class="form-check-label" for="${e.MaND}" style="cursor: pointer;">
                        <span class="fw-bold">${e.Ten}</span> <br>
                    </label>
            </div>
        `;o.insertAdjacentHTML("beforeend",t)}),openForm(".form-thongbao-cover"),document.querySelector(".form-thongbao").action=`/${e}/thongbao/${t}?_method=POST`}const formSoanTB=document.querySelector(".form-thongbao");async function TraLoiThongBao(e,t,n){let r=document.getElementsByName("MaNN")[0];r.value=n,openForm(".form-thongbao-traloi-cover"),document.querySelector(".form-thongbao-traloi").action=`/${e}/thongbao/traloi/${t}?_method=POST`}formSoanTB&&formSoanTB.addEventListener("submit",function(e){e.preventDefault();let t=!1,n=document.getElementsByName("TieuDe")[0],r=document.getElementsByName("NoiDung")[0],o=document.querySelectorAll('input[name="NNhan[]"]:checked'),i=n.value.trim(),a=r.value.trim();if(""===i&&(showErr(n,document.querySelector("#TieuDeError"),"Ti\xeau đề kh\xf4ng hợp lệ"),t=!0),""===a&&(showErr(r,document.querySelector("#NoiDungError"),"Nội dung kh\xf4ng hợp lệ"),t=!0),0===o.length){let l=document.querySelector("#NNhanError"),u=document.querySelector(".containerNguoiNhan");showErr(u,l,"Vui l\xf2ng chọn \xedt nhất 1 người nhận"),t=!0}t||e.currentTarget.submit()});const formTLTB=document.querySelector(".form-thongbao");function showLoading(){document.getElementById("loading-overlay").style.display="flex",document.body.style.overflow="hidden"}function hideLoading(){let e=document.getElementById("loading-overlay");e&&(e.style.display="none"),document.body.style.overflow="auto"}formTLTB&&formTLTB.addEventListener("submit",function(e){e.preventDefault();let t=!1,n=document.getElementsByName("TieuDeTL")[0],r=document.getElementsByName("NoiDungTL")[0],o=n.value.trim(),i=r.value.trim();""===o&&(showErr(n,document.querySelector("#TieuDeTLError"),"Ti\xeau đề kh\xf4ng hợp lệ"),t=!0),""===i&&(showErr(r,document.querySelector("#NoiDungTLError"),"Nội dung kh\xf4ng hợp lệ"),t=!0),t||e.currentTarget.submit()}),window.addEventListener("load",function(){hideLoading()}),links.forEach(e=>{e.addEventListener("click",function(e){let t=this.getAttribute("href"),n=this.getAttribute("target");if(t&&"#"!==t&&!t.startsWith("javascript")&&"_blank"!==n){if(t.match(/\.(zip|rar|doc|docx|xls|xlsx|pdf|png|jpg)$/i))return;showLoading(),setTimeout(function(){hideLoading()},1e4)}})});const provinceSelect=document.getElementById("province"),districtSelect=document.getElementById("district"),wardSelect=document.getElementById("ward"),streetInput=document.getElementById("street"),fullAddressInput=document.getElementById("fullAddress");var dataVietnam=[];axios.get("https://raw.githubusercontent.com/kenzouno1/DiaGioiHanhChinhVN/master/data.json").then(e=>{renderOptions(dataVietnam=e.data,"province")}).catch(e=>{console.error("Lỗi tải dữ liệu:",e),alert("Kh\xf4ng tải được dữ liệu h\xe0nh ch\xednh. Vui l\xf2ng kiểm tra mạng!")});var renderOptions=(e,t)=>{let n='<option value="">-- Chọn --</option>';e.forEach(e=>{n+=`<option value="${e.Id}" data-name="${e.Name}">${e.Name}</option>`}),"province"===t?provinceSelect.innerHTML=n:"district"===t?(districtSelect.innerHTML=n,districtSelect.disabled=!1):"ward"===t&&(wardSelect.innerHTML=n,wardSelect.disabled=!1)};function updateAddressString(){let e=provinceSelect.options[provinceSelect.selectedIndex]?.dataset.name||"",t=districtSelect.options[districtSelect.selectedIndex]?.dataset.name||"",n=wardSelect.options[wardSelect.selectedIndex]?.dataset.name||"",r=streetInput.value.trim();provinceSelect.value||districtSelect.value||wardSelect.value||r?fullAddressInput.value=`${r}, ${n}, ${t}, ${e}`:fullAddressInput.value=""}provinceSelect.addEventListener("change",function(){if(districtSelect.innerHTML='<option value="">-- Chọn Quận/Huyện --</option>',districtSelect.disabled=!0,wardSelect.innerHTML='<option value="">-- Chọn Phường/X\xe3 --</option>',wardSelect.disabled=!0,this.value){let e=dataVietnam.find(e=>e.Id===this.value);e&&e.Districts&&renderOptions(e.Districts,"district")}updateAddressString()}),districtSelect.addEventListener("change",function(){if(wardSelect.innerHTML='<option value="">-- Chọn Phường/X\xe3 --</option>',wardSelect.disabled=!0,this.value){let e=dataVietnam.find(e=>e.Id===provinceSelect.value),t=e.Districts.find(e=>e.Id===this.value);t&&t.Wards&&renderOptions(t.Wards,"ward")}updateAddressString()}),wardSelect.addEventListener("change",updateAddressString),streetInput.addEventListener("input",updateAddressString);